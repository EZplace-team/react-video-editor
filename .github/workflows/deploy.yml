name: Build and Deploy

on:
  push:
    branches: [ "main", "dev" ]
  workflow_dispatch:

env:
  IMAGE_NAME: react-video-editor
  CONTAINER_NAME: react-video-editor

jobs:
  build-push-deploy:
    runs-on: self-hosted
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set Environment Variables
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "TAG=prod" >> $GITHUB_ENV
            echo "TARGET_ENV=prod" >> $GITHUB_ENV
          else
            echo "TAG=test" >> $GITHUB_ENV
            echo "TARGET_ENV=test" >> $GITHUB_ENV
          fi

      - name: Login to Tencent Registry
        run: |
          echo "${{ secrets.TCR_PASSWORD }}" | docker login ${{ secrets.TCR_REGISTRY }} -u "${{ secrets.TCR_USERNAME }}" --password-stdin

      - name: Build and Push Docker Image
        run: |
          FULL_IMAGE_NAME="${{ secrets.TCR_REGISTRY }}/${{ secrets.TCR_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}"
          echo "Building and Pushing $FULL_IMAGE_NAME"
          
          docker build -t $FULL_IMAGE_NAME .
          docker push $FULL_IMAGE_NAME
          
          echo "FULL_IMAGE_NAME=$FULL_IMAGE_NAME" >> $GITHUB_ENV

      # ==========================================
      # 部署到本地 (正式环境 - main 分支)
      # ==========================================
      - name: Deploy Locally (Prod)
        if: env.TARGET_ENV == 'prod'
        run: |
          echo "Deploying locally (Prod)..."
          
          # 生成 .env 文件
          echo "${{ secrets.ENV_PROD_FRONTEND }}" > /tmp/react-video-editor.env
          
          # 停止旧容器
          docker stop ${{ env.CONTAINER_NAME }} || true
          docker rm ${{ env.CONTAINER_NAME }} || true
          
          # 启动新容器
          docker run -d \
            --name ${{ env.CONTAINER_NAME }} \
            --restart unless-stopped \
            -p 3000:3000 \
            --env-file /tmp/react-video-editor.env \
            ${{ env.FULL_IMAGE_NAME }}
            
          # 清理镜像
          docker image prune -f
          
          # 清理临时文件
          rm -f /tmp/react-video-editor.env
            
          echo "Prod Deployment Success!"

      # ==========================================
      # 部署到腾讯云 (测试环境 - dev 分支，SSH 远程)
      # ==========================================
      - name: Deploy to Tencent (Test)
        if: env.TARGET_ENV == 'test'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.TEST_SSH_HOST }}
          username: root
          key: ${{ secrets.TEST_SSH_KEY }}
          script: |
            echo "Deploying to Tencent Test..."
            
            # 登录 TCR
            echo "${{ secrets.TCR_PASSWORD }}" | docker login ${{ secrets.TCR_REGISTRY }} -u "${{ secrets.TCR_USERNAME }}" --password-stdin
            
            # 准备环境变量
            echo "${{ secrets.ENV_TEST_FRONTEND }}" > /root/react-video-editor.env
            
            # 拉取镜像
            FULL_IMAGE="${{ secrets.TCR_REGISTRY }}/${{ secrets.TCR_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ env.TAG }}"
            docker pull $FULL_IMAGE
            
            # 重启容器
            docker stop ${{ env.CONTAINER_NAME }} || true
            docker rm ${{ env.CONTAINER_NAME }} || true
            
            docker run -d \
              --name ${{ env.CONTAINER_NAME }} \
              --restart unless-stopped \
              -p 3000:3000 \
              --env-file /root/react-video-editor.env \
              $FULL_IMAGE
              
            docker image prune -f
            echo "Test Deployment Success!"

